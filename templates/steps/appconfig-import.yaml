parameters:
- name: dryRun
  type: boolean
  default: true
- name: environmentObj
  displayName: deployment env
  type: object
- name: appDeployConfig
  displayName: Details to deploy the app
  type: object
  default: null
- name: workingDirectory
  type: string
- name: serviceName
  type: string
- name: PSHelperDirectory
  type: string
- name: AppConfigModuleDirectory
  type: string     
steps:
  - checkout: Self
    path: s/ 
  - checkout: PipelineCommon
    path: s/PipelineCommon
  - ${{ if ne(parameters.appDeployConfig, '') }}:          
    - pwsh: |
        $PSVersionTable
        sudo apt-get install -y powershell
      errorActionPreference: silentlyContinue
      displayName: 'Upgrade PowerShell Version'  
    - task: PowerShell@2
      displayName: 'Validate Config File'
      inputs:
        targetType: filePath
        filePath: '$(Pipeline.Workspace)/s/PipelineCommon/templates/powershell/build/ValidateConfigFile.ps1'
        arguments: > 
         -SchemaFilePath '$(Pipeline.Workspace)/s/PipelineCommon/templates/config/schema.${{ parameters.appDeployConfig.filetype }}'  
         -ConfigFilePath '${{ parameters.appDeployConfig.filepath }}/appConfig.${{ parameters.environmentObj.name }}.${{ parameters.appDeployConfig.filetype }}'
         -AppConfigModuleDirectory ${{ parameters.AppConfigModuleDirectory }} 
        failOnStderr: true
        pwsh: true
        workingDirectory: '$(Pipeline.Workspace)/s'
    - task: replacetokens@5
      displayName: 'Replace tokens in config'
      inputs:
        tokenPattern: doublebraces
        inlineVariables: |
          keyvaultName: ${{ parameters.environmentObj.appKeyVault }}
          serviceName: ${{ parameters.serviceName }}
          env: ${{ parameters.environmentObj.name }}
          keyVaultContentType: "application/vnd.microsoft.appconfig.keyvaultref+json;charset=utf-8"
          resourceid: 'uri":"https://${{ parameters.environmentObj.appKeyVault }}.vault.azure.net/secrets'
        targetFiles: |
          ${{ parameters.workingDirectory }}/${{ parameters.appDeployConfig.filepath }}/appConfig.${{ parameters.environmentObj.name }}.${{ parameters.appDeployConfig.filetype }}
    - task: AzureCLI@2
      displayName: 'Import Azure App Configuration '
      inputs:
        azureSubscription: '${{ parameters.environmentObj.serviceConnection}}'
        scriptType: pscore
        scriptLocation: scriptPath
        scriptPath: '$(Pipeline.Workspace)/s/PipelineCommon/templates/powershell/build/ImportAppConfig.ps1'
        arguments: > 
          -AppConfig '${{ parameters.environmentObj.appConfiguration }}' 
          -ServiceName '${{ parameters.serviceName }}' 
          -ConfigFilePath '${{ parameters.appDeployConfig.filepath }}/appConfig.${{ parameters.environmentObj.name }}.${{ parameters.appDeployConfig.filetype }}'          
          -KeyVault '${{ parameters.environmentObj.appKeyVault }}'
          -PSHelperDirectory ${{ parameters.PSHelperDirectory }} 
          -AppConfigModuleDirectory ${{ parameters.AppConfigModuleDirectory }} 
        addSpnToEnvironment: true          
        failOnStandardError: false
        workingDirectory: '$(Pipeline.Workspace)/s'  
  