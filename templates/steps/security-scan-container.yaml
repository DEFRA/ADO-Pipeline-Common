parameters:
  - name: snykConnection
    type: string       
  - name: acrRepoName
    type: string   
  - name: acrRepoTagVersion
    type: string
  - name: snykOrganizationName
    type: string
    default: 'defra'
  - name: failOnThreshold
    type: string
    default: 'high'
  - name: dockerfilePath
    type: string
    default: './Dockerfile'
  - name: snykPolicyFilePath
    type: string
    default: './.snyk'

variables:
  - name: acrRepoNameLower
    value: ${{ lower(parameters.acrRepoName }}

steps:   
- task: SnykSecurityScan@1
  displayName: 'Snyk containter scan'
  inputs:
    serviceConnectionEndpoint: ${{ parameters.snykConnection }} 
    testType: 'container'
    dockerImageName:  ${{ variables.acrRepoNameLower }}:${{ parameters.acrRepoTagVersion }}
    dockerfilePath: '${{ parameters.dockerfilePath }}'
    monitorOnBuild: false
    failOnIssues: ${{ eq(variables['Build.Reason'], 'PullRequest') }}
    projectName: '${{ variables.acrRepoNameLower }}'
    organization: '${{ parameters.snykOrganizationName }}'    
    failOnThreshold: '${{ parameters.failOnThreshold }}'
    additionalArguments: '--policy-path=${{ parameters.snykPolicyFilePath }} --exclude-base-image-vulns'
  enabled: true
  continueOnError: ${{ ne(variables['Build.Reason'], 'PullRequest') }}
    
