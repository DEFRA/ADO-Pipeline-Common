parameters:
  - name: service
    type: string
  - name: testDir
    type: string
  - name: testOutputDir
    type: string
  - name: typeOfTest
    type: string    
    default: 'PreDeploy'
  - name: url
    type: string
    default: ''
  - name: appBuildConfig
    type: object
    default: null
steps:  
  - pwsh: |
      if(Test-Path -Path "${{ parameters.testDir }}/docker-compose.test.yaml"){
        Write-Output "##vso[task.setvariable variable=docker_compose_dot_test_yaml]true"
      }
    displayName: Intg Test - File Validation
  - ${{ if eq(parameters.typeOfTest,'PreDeploy') }}:
    - pwsh: |
        sudo mkdir -R 777 ${{ parameters.testOutputDir }}
        docker-compose -f docker-compose.yaml -f docker-compose.test.yaml -p "${{ parameters.service }}-test" up
      displayName: Intg Test - Run
      condition: eq(variables.docker_compose_dot_test_yaml, 'true')
      enabled: false
  - ${{ if eq(parameters.typeOfTest,'PostDeploy') }}:
    - task: AzureKeyVault@2
      displayName: Read KV Secrets
      inputs:
        azureSubscription: ${{ parameters.appBuildConfig.keyVaultServiceConnection }}
        KeyVaultName: ${{ parameters.appBuildConfig.keyVaultName }}
        SecretsFilter: 'PACT-BROKER-URL,PACT-BROKER-USERNAME,PACT-BROKER-PASSWORD'
        RunAsPreJob: false
      enabled: false
    - pwsh: |
        sudo mkdir -R 777 ${{ parameters.testOutputDir }}
        $Env:TEST_ENVIRONMENT_ROOT_URL="https://${{ parameters.url }}"
        $Env:PACT_BROKER_URL="https://$(PACT-BROKER-URL)"
        $Env:PACT_BROKER_USERNAME="https://$(PACT-BROKER-USERNAME)"
        $Env:PACT_BROKER_PASSWORD="https://$(PACT-BROKER-PASSWORD)"
        docker-compose -f docker-compose.yaml -f docker-compose.test.yaml -p "${{ parameters.service }}-test" up
      displayName: Intg Test - Run
      condition: eq(variables.docker_compose_dot_test_yaml, 'true')
      enabled: false
  - task: PublishPipelineArtifact@1
    displayName: Intg Test - Publish Report
    inputs:
      targetPath: ${{ parameters.testOutputDir }}
      artifact: $(build.buildid)-int-results
    condition: eq(variables.docker_compose_dot_test_yaml, 'true')
    enabled: false