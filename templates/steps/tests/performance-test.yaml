parameters:
  - name: testDir
    type: string
  - name: testOutputDir
    type: string
  - name: typeOfTest
    type: string    
    default: 'PreDeploy'
  - name: url
    type: string
    default: ''
  - name: scriptPath
    type: string
steps:  
  - script: |
      echo "https;${{ parameters.url }};443" >> jmeterConfig.csv
    workingDirectory: ${{ parameters.testDir }}
    displayName: Update jmeterConfig      
    condition: ${{ eq(parameters.typeOfTest,'PostDeploy') }}

  - pwsh: |
      sudo mkdir -p -m 777 ${{ parameters.testOutputDir }}/performance/htmlreport
      sudo chmod -R 777 ${{ parameters.testOutputDir }}/performance
      cd ${{ parameters.testDir }} 
      docker-compose -f ../../docker-compose.yaml -f docker-compose.jmeter.yaml run jmeter-test
    displayName: JMeter - Run Tests

  - script: |
      JMETER_RESULTS=${{ parameters.testOutputDir }}/performance/testresults.jtl
      JUNIT_RESULTS=${{ parameters.testOutputDir }}/performance/testresults.xml
      python3 ${{ parameters.scriptPath }} $JMETER_RESULTS $JUNIT_RESULTS
    workingDirectory: '$(System.DefaultWorkingDirectory)'
    displayName: 'Convert JMeter Results to JUnit Format'

  - task: PublishPipelineArtifact@1
    displayName: JMeter - Publish Test Report
    inputs:
      targetPath: ${{ parameters.testOutputDir }}/performance
      artifact: $(build.buildid)-jmeter-results

  - task: PublishTestResults@2
    inputs:
      testResultsFormat: 'JUnit'
      testRunTitle: 'Performance Test Result'
      testResultsFiles: '${{ parameters.testOutputDir }}/performance/testresults.xml'
      failTaskOnFailedTests: false #TODO: THis needs to be set to true
    displayName: 'Publish Performance Test Results'

  # - task: LakshayKaushik.PublishHTMLReports.publishhtmlreport.publishhtmlreport@1
  #   displayName: Publish Html Report
  #   inputs:
  #     htmlType: Jmeter
  #     JmeterReportsPath: '${{ parameters.testOutputDir }}/performance/htmlreport'    