name: ${{ parameters.project }}-${{ parameters.buildNumber }}-${{ parameters.appKeyVault }}-${{ parameters.variableGroups }}

parameters:
- name: secretNames
  type: string  
- name: variableGroups
  type: string  
- name: serviceConnection
  type: string
- name: appKeyVault
  type: string    
- name: privateAgentName
  type: string   
- name: buildNumber
  type: string  
- name: project
  type: string 
- name: organization
  type: string     
trigger:
- none

resources:
  repositories:
    - repository: ADOPipelineCommon
      name: DEFRA/ADO-Pipeline-Common
      endpoint: DEFRA
      type: github
      ref: refs/heads/rv/323021-importvariables

variables:
- ${{ each varGroup in split(parameters.variableGroups, ';') }}:
  - group: '${{ varGroup }}'
- name: PSHelperDirectory
  value: '$(Pipeline.Workspace)/s/ADO-Pipeline-Common/templates/powershell/modules/ps-helpers'
  
stages:
- stage: ImportSecrets
  pool: ${{ parameters.privateAgentName }}  
  jobs:
  - job: ${{ parameters.appKeyVault }}
    steps:
      - script: | 
          "${{ parameters.organization }}${{ parameters.project }}/_build/results?buildId=${{ parameters.buildNumber }}"
        displayName: 'Source Build URL'
      - ${{ each secret in split(parameters.secretNames, ';') }} :
        - template: ../steps/secrets-import-kv.yaml
          parameters:
            workingDirectory: '$(Pipeline.Workspace)/s'
            PSHelperDirectory: ${{ variables.PSHelperDirectory }}
            secretName: ${{ secret }}
            serviceConnection: ${{ parameters.ServiceConnection }}
            appKeyVault: ${{ parameters.appKeyVault }}  